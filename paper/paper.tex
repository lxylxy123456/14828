\documentclass[conference]{IEEEtran}
\IEEEoverridecommandlockouts
% The preceding line is only needed to identify funding in the first footnote. If that is unneeded, please comment it out.
\usepackage{cite}
\usepackage{amsmath,amssymb,amsfonts}
\usepackage{algorithmic}
\usepackage{graphicx}
\usepackage{textcomp}
\usepackage{xcolor}
\usepackage{verbatim}
\usepackage{listings}
\lstset{basicstyle=\ttfamily, upquote=true}
\def\BibTeX{{\rm B\kern-.05em{\sc i\kern-.025em b}\kern-.08em
    T\kern-.1667em\lower.7ex\hbox{E}\kern-.125emX}}
\begin{document}

\title{Arbitrary Code Injection in Adblock Plus
% \thanks{Identify applicable funding agency here. If none, delete this.}
}

\author{\IEEEauthorblockN{Eric Li}
\IEEEauthorblockA{Information Networking Institute \\
Carnegie Mellon University\\
Pittsburgh, U.S.A \\
xiaoyili@andrew.cmu.edu}
\and
\IEEEauthorblockN{Teresa Alberto}
\IEEEauthorblockA{
Information Networking Institute \\
Carnegie Mellon University\\
Pittsburgh, U.S.A \\
talberto@andrew.cmu.edu
}
\and
\IEEEauthorblockN{Chengcheng Ding}
\IEEEauthorblockA{
Information Networking Institute \\
Carnegie Mellon University\\
Pittsburgh, U.S.A \\
chengchd@andrew.cmu.edu
}
}

\maketitle

\begin{abstract}
TODO
% This document is a model and instructions for \LaTeX. This and the IEEEtran.cls file define the components of your paper [title, text, heads, etc.]. *CRITICAL: Do Not Use Symbols, Special Characters, Footnotes, or Math in Paper Title or Abstract.
\end{abstract}

\begin{IEEEkeywords}
browser security, browser extension, ad blocking, XSS
\end{IEEEkeywords}

\section{Introduction}
% Author: Chengcheng Ding
Since the very beginning of their introduction, browser extensions expose additional attack surfaces for browsers. Their popularity among users only makes the matter worse: a vulnerability in a popular extension can affect millions of users. One such popular extension is Adblock Plus, which has tens of millions of users on Chrome and Firefox combined \cite{noauthor_adblockchrome_nodate, noauthor_adblockfirefox_nodate}. In this article, we will investigate a vulnerability introduced in a previous version of Adblock Plus that enabled the execution of arbitrary code on users' devices.

Adblock Plus has a very well-intended feature that allows users to apply custom filter rules. To do so, users can supply a text file that provides (a list of) rule(s) written in the syntax specified by Adblock Plus. Similarly, users can also apply custom filter rules crafted by others to their Adblock Plus extensions. This introduced another party in the threat model.

A standard custom filter rule mentioned above consists of 2 items:
\begin{enumerate}
    \item A pattern of URIs. All requests made to a URI that fits such a pattern will be filtered
    \item The action to the request that will be filtered. The most obvious and straightforward example would be blocking that request.
\end{enumerate}

In Adblock Plus version 3.2, released on July 17, 2018, a new option for filter action is introduced: rewrite. It allowed users to rewrite requests to a new destination. In that release, it is restricted that the new destination must be of the same origin as the original request. Unfortunately, this introduced new vulnerabilities that allowed arbitrary code execution on user machines that somehow applied malicious filter rules to their extension \cite{abp_code_injection,abp_issue_6622,abp_rewrite_pr,abp_filter_guide}.

We contribute the following:
\begin{enumerate}
    \item An explanation of the technology details behind the attack.
    \item A detailed guide to re-implementing the attack, that specifies corresponding versions of the products related, and a demo website that showcases the attack.
    \item What we can learn from this vulnerability: its impacts, and what vendors can do to mitigate against it.
\end{enumerate}

\section{Background and Goals}
\subsection{Massive Adaptation of Ad-Blocking Extensions}
% Author: Chengcheng Ding
Extensions play a critical role in the capabilities of modern browsers, enabling customized web experiences. Among them is a popular category of extensions that blocks advertisements on web pages. One of the most popular in that category is Adblock Plus. According to statistics from the Chrome extensions web store and Mozilla Firefox add-on store, tens of millions of users have Adblock Plus installed \cite{noauthor_adblockchrome_nodate, noauthor_adblockfirefox_nodate}. According to a study by Pujol et al., 22\% of the most active users analyzed browse the Web with Adblock Plus. In fact, Ad-blocking extensions are so popular that advertisement vendors have begun to take active measures against them \cite{mughees_first_2016}. Therefore, vulnerabilities from the Adblock Plus extension can impact a considerable amount of internet users. That is why we have chosen to investigate a vulnerability in a previous version of Adblock Plus.

\subsection{Custom Filters in Adblock Plus}
% Author: Chengcheng Ding
The default advertisement-blocking behaviors of Adblock Plus are defined by a filter list included in the extension. In addition to that, Adblock Plus enables custom filters created by users. These filters allow users to block ads and other unwanted content that may not be covered by the default filter lists. Users can create their own filters by specifying URLs or patterns of URLs, and the actions they want to take against them, such as blocking or allowing. Custom filter lists can also be shared with other Adblock Plus users. From a security standpoint, custom filters involve additional third parties in the flow of ad-blocking, potentially creating additional attack surfaces. The filters are not written in a syntax easily understandable for most average users. Hence, attackers can embed malicious filter actions and present them to users as a filter for additional features, if the filter rules' functionalities allow them.

\subsection{The Rewrite Rule: What and Why}
% Author: Chengcheng Ding
In version 3.2 of Adblock Plus, released on July 17, 2018, a new filter option called "rewrite" was introduced. It allows users to rewrite outgoing requests to certain URL(s). In this version, the destination of requests can be rewritten to resources within the same origin. For example, a request to "foo.com/ad.js" can be rewritten to "foo.com/not-ad.js".

There can be multiple correct usages of the rewrite filter. The first (and primary) one is when simply blocking a request to a certain advertisement-related resource will lead to an error. That's when rewriting the request is a reasonable way to block advertisements with minimal impact on user experience.

Another potential way of using the rewrite filter is eliminating certain HTTP request parameters related to privacy. Advertisers have long used HTTP request parameters for cross-site tracking. Parameters in advertisement links help vendors figure out where the click comes from. Therefore, the rewrite filter can be utilized in this scenario to eliminate request parameters related to tracking.

\subsection{Goals of This Project}
% Author: Chengcheng Ding
There are mainly 2 goals for this project, centered around the vulnerability introduced by the first implementation of the rewrite rule, and its implications.

The first goal is to prove that the vulnerability implies a previously understated attack surface. The vulnerability's chain of exploits utilizes vulnerabilities, or even features, that would be considered low-impact or no-impact on their own. For example, a crucial component of this vulnerability, open redirect, would be considered a feature instead of a vulnerability in many websites. As a matter of fact, Google is still choosing to keep its open redirects while acknowledging it can be a tool for phishers.\cite{noauthor_open_nodate}

The second goal of this project is to recreate a proof of concept of the attack scenario. The proof of concept will specify the versions of all of the related software, and provide a skeleton website to demonstrate the capabilities of the attack. The details of the proof of concept can be found in Section \ref{sec:Implementation}.

\section{Attack Outline}
TODO
\begin{itemize}
\item Victim website: Open redirect combined with fetching and loading JS code provokes worse problems.
\item Victim user: install malicious filter list (may be updated automatically), visit victim website.
\item Attacker: control the malicious filter list.
\item Potential impact.
\end{itemize}

\section{Implementation}
\label{sec:Implementation}
% Eric Li: I am editing this section on GitHub, please do not edit this section.
% Author: Eric Li

In this section, we explain how we reproduce the attack. We provide a fully functioning environment for demonstrating this attack. We write two websites using Flask as the attacker and the victim website. We also add Content Security Policy (CSP) logics to demonstrate the recommended mitigation in \cite{abp_code_injection}.

TODO: we make our project open source?

\subsection{Recreating the Environment}

As \cite{abp_code_injection} mentions, the rewrite filter vulnerability is only exploitable on Adblock Plus version between 3.2 and 3.5.1. Thus, the first step for us is to find old version of of this extension. Unfortunately, the official Chrome Web Store and Add-ons for Firefox website no longer provide these versions. So we find old versions from unofficial sources.

We are able to find old version of the extension for Chrome on Crx4Chrome \cite{cr4chrome_abp}, a website that provides archived extensions for Chrome. We are unable to find old version of the extension for Firefox easily. However, we argue that since the extension is designed to be browser-independent, the same attack should work on Firefox and Safari.

Adblock Plus 3.2 cannot be directly installed on the latest version of Chromium, because the extension is packed in a deprecated format and installing the extension triggers the \lstinline{CRX_HEADER_INVALID} error. However, it is possible to extract the packed extension as a ZIP archive file and install the extension to Chromium in developer mode \cite{stackoverflow_crx_header_invalid}.

The problem with Adblock Plus 3.2 is that it uses manifest V2. However, manifest V2 is deprecated and planned to be removed, so Chromium browsers in the future will not be able to install Adblock Plus 3.2 \cite{chrome_manifest_v2}. Thus, we demonstrate that it is possible to install Adblock Plus 3.2 on an old version of Chromium.

\cite{chromium_old_download} provides guidance to download old versions of the Chromium browser. We choose Chromium 69.0.3497, a version released close to the release date of Adblock Plus 3.2.
Following the guidance, we query the position lookup and find that the branch base position of this version is 576753. Finally, we can download the Chromium browser's snapshot at this version. Adblock Plus 3.2 can be installed directly in Chromium 69, by dragging the CRX package to the browser's extension management page.

In this research, we only test reproducing the attack on Linux. However, since Chromium is a cross-platform browser, we expect the same attack to be reproducible on Windows and macOS.

\subsection{Attacker Website}

We implement the attacker website using Flask as the backend. The host name and port of the attacker website are \lstinline{attacker.local:8080}. We use plain HTML and JavaScript as the frontend. The attacker website has two features.

First, the attacker website hosts an filter rules file that will be loaded to the victim user's browser. To make demonstration easy, we design an interfaces using HTML and JavaScript to modify the filter rules from a browser. The attacker can choose from any subset of the pre-defined 8 rules:

\begin{enumerate}
	\item Block advertisement image.
		% ||*/static/advertisement.png
	\item Block static JavaScript.
		% ||*/static/static.js
	\item Rewrite advertisement image with another image.
		% ||*/static/advertisement.png$rewrite=/static/welcome.png
	\item Rewrite XMLHttpRequest (XHR) that sends private information with URL that does not send private information.
		% ||*/advertisement?city=*&role=*&company=*^$rewrite=/advertisement
	\item Rewrite static Javacsript.
		% ||*/static/static.js$rewrite=/static/replace.js
	\item Rewrite dynamic JavaScript to static file.
		% ||*/static/dynamic.js$rewrite=/static/replace.js
	\item Rewrite dynamic JavaScript to redirect URL.
		% ||*/static/dynamic.js$rewrite=/redirect
	\item Rewrite dynamic JavaScript to user uploaded file.
		% ||*/static/dynamic.js$rewrite=/upload/user.js
\end{enumerate}

Second, the attacker website needs to host the malicious JavaScript payload to be executed on the victim browser. To simplify our design, we host the JavaScript payload statically. The attacker website sets Access-Control-Allow-Origin to \lstinline{"*"} to allow the malicious JavaScript from being read by the victim website on the victim browser.

\subsection{Victim Website}

Similar to the attacker website, we implement the attacker website using Flask as the backend. The host name and port of the victim website are \lstinline{victim.local:8080}. We use plain HTML and JavaScript as the frontend. The victim website has multiple sections, as discussed below in detail.

\subsubsection{Welcome Image}

The victim website loads a welcome image using HTML's \lstinline{<img>} tag. This provides a image for rewriting the advertisement image later.

\subsubsection{Advertisement Image}

The victim website loads an advertisement image using HTML's \lstinline{<img>} tag. The website also uses JavaScript to detect whether loading the advertisement image is successful. The image is loaded successfully if the \lstinline{load} event listener is called. The image fails to load if the \lstinline{error} event listener is called.

\subsubsection{Targeted Advertisement}

The victim website loads an advertisement using XMLHttpRequest (XHR). The request sends information that undermines the user's privacy, such as the user's location. For demonstration purpose we hard code this information. The server returns an advertisement as a string. The frontend displays the string on HTML.

The purpose of this section is to show that rewrite rules can modify HTTP requests to prevent leakage of users' privacy.

Note that we use XMLHttpRequest (XHR) in the entire demonstration. However, other techniques like fetch also work.

\subsubsection{Static JavaScript}

The victim website loads a JavaScript script statically using the \lstinline{<script>} tag in HTML. The loaded script changes HTML to indicate that the script is loaded correctly. This section demonstrates that Adblock Plus is able to block a static script from loading. However, rewrite rules cannot modify the request to load another script instead.

\subsubsection{Dynamic JavaScript}

The victim website loads a JavaScript script dynamically when the user clicks a button. The browser first requests the content of the script using XHR. The browser then evaluates the downloaded script using \lstinline{eval()}. This is similar to how Google Maps dynamically load JavaScripts while the user is browsing the map. Similar to Google Maps, the victim website must enable \lstinline{script-src 'unsafe-eval'} in CSP to make dynamically loading JavaScript working.

\subsubsection{Open Redirect}

One weakness of the victim website is open redirect, where any user can define HTTP redirects in the website \cite{cwe_open_redir}. In the victim website, the attacker can control the URL \lstinline{/redirect} to return an HTTP 302 to any URL. Example URL include a JavaScript on the victim website and a JavaScript on the attacker website.

The I'm Feeling Lucky button provided by Google Search has this weakness in 2019. When the user clicks the button, the website sends a GET request to Google's server. The request contains the user's query and \lstinline{btnI} parameter to indicate the user clicks the I'm Feeling Lucky button. Google's server returns an HTTP 302 response to the first Google Search result. An attacker can use this feature as an open redirect. The attacker simply needs to construct a Google Search query that places the redirect target as the first Google Search result. This weakness is fixed by Google later, as discussed in TODO.

\subsubsection{User Uploaded File}

Another weakness of the victim website is user uploaded file with JavaScript content \cite{cwe_upload_file}. The victim website does not perform any sanitization to the file uploaded, and any user of the victim website can view the uploaded file. Thus, if the attacker can trick the victim browser to load the uploaded file, the attacker can achieve arbitrary code execution.

\subsubsection{CSP}

The victim website allows dynamically configuring the website's CSP. This allows easy understanding the effectiveness of different defense strategies. In an attempt to defend, the victim user can try to remove \lstinline{script-src *} from CSP and/or to add \lstinline{connect-src 'self'} to the CSP.

\subsection{Attacker User}

The attacker user runs any modern browser that can run JavaScript. The attacker user opens the attacker website and interacts with it. The attacker user also interacts with the victim website by changing the open redirect target and uploading the JavaScript file.

\subsection{Victim User}

We setup the victim user in a Linux virtual machine. The virtual machine runs Chromium 69. We install AdBlock Plus 3.2 and add the filter rules file of the attacker website to AdBlock Plus. The victim user then opens and interacts with victim website. When the attacker updates the filter rules file, the victim needs to click the update button in AdBlock Plus's configuration page.

\subsection{Experiment Results}

Using the setup described above, we perform multiple experiments to demonstrate the capabilities of AdBlock Plus and the arbitrary code execution attack.

\subsubsection{Blocking Image}

AdBlock Plus can block the advertisement image in the victim website. However, the victim website can see that the advertisement image fails to be loaded using the JavaScript \lstinline{error} event listener.

\subsubsection{Blocking Static JavaScript}

AdBlock Plus can block the static JavaScript in the victim website.

\subsubsection{Rewriting Image}

AdBlock Plus can rewrite the advertisement image in the victim website with another image on the victim website. Since the \lstinline{<img>} tag successfully loads an image, the victim website cannot detect the rewrite using the JavaScript \lstinline{error} event listener. This demonstrates that the intended use of the rewrite feature \cite{abp_filter_guide}.

\subsubsection{Rewriting Request Paramters}

AdBlock Plus can rewrite an XHR request to a different URL. In our example, we remove the request URL's query string, which contains private information of the victim user. This is another intended use of the rewrite feature \cite{abp_issue_6622}.

\subsubsection{Rewriting Static JavaScript}

AdBlock Plus is not able to rewrite static JavaScript in the victim website. During the design of the rewrite feature, rewriting static JavaScript is disallowed due to security considerations \cite{abp_issue_6622}.

\subsubsection{Rewriting Dynamic JavaScript}

AdBlock Plus is able to rewrite dynamic JavaScript loaded from XHR request. So when the victim website loads a JavaScript from the its own origin dynamically, AdBlock Plus can change to let it load a different JavaScript from the same origin.

\subsubsection{Attack Using Open Redirect}

A victim website that loads dynamic JavaScript and has the open redirect weakness can be attacked. The attacker first adds AdBlock Plus rule to rewrite the dynamic JavaScript's URL to the open redirect URL. The attacker then controls the open redirect to return HTTP 302 to an attacker-controlled website. The attacker controlled website returns the malicious JavaScript code.

Removing \lstinline{script-src *} from CSP does not defend against this attack. The dynamic JavaScript is downloaded using XHR, which is not controlled by \lstinline{script-src}.

Adding \lstinline{connect-src 'self'} to the CSP defends against this attack. This rule prevents XHR from being redirected to an origin other than the victim website itself. However, this breaks functionality if the victim website needs to send XHR requests to other websites.

\subsubsection{Attack Using User Uploaded File}

A victim website that loads dynamic JavaScript and has the user uploaded file with JavaScript content weakness can be attacked.

TODO

\begin{itemize}
\item Recreating the environment.
\item Adblock plus version vulnerable, browser version
\item Attacker’s website.
\item Victim’s website.
\item CSP policies.
\end{itemize}
% Eric Li: I am editing this section on GitHub, please do not edit this section.

\section{Discussion and Limitations}
TODO
\begin{itemize}
\item How Google mitigated the issue.
\item How Adblock Plus defended (limits the ability of filter rules).
\item Public warnings previous the deploy of the \$rewrite feature.
\item Limitations: downgrade of browser version was needed.
\item Limitations: further analysis on other browsers.
\item Possible mitigation: check signature of dynamic JS before eval.
\end{itemize}

\section{Related Work}
TODO
\begin{itemize}
\item Advertisement blocking and detection.
\end{itemize}

\section{Conclusion}
TODO

\section*{Acknowledgment}
TODO

\bibliographystyle{IEEEtran}
\bibliography{references}

\appendix
TODO: respond to peer review

\end{document}

\begin{table}[htbp]
\caption{Table Type Styles}
\begin{center}
\begin{tabular}{|c|c|c|c|}
\hline
\textbf{Table}&\multicolumn{3}{|c|}{\textbf{Table Column Head}} \\
\cline{2-4} 
\textbf{Head} & \textbf{\textit{Table column subhead}}& \textbf{\textit{Subhead}}& \textbf{\textit{Subhead}} \\
\hline
copy& More table copy$^{\mathrm{a}}$& &  \\
\hline
\multicolumn{4}{l}{$^{\mathrm{a}}$Sample of a Table footnote.}
\end{tabular}
\label{tab1}
\end{center}
\end{table}

\begin{figure}[htbp]
\centerline{\includegraphics{fig1.png}}
\caption{Example of a figure caption.}
\label{fig}
\end{figure}


